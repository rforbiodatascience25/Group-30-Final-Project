---
title: "03_augment"
format: html
---

```{r}
library(tidyverse)
library(readr)
library(dplyr)
library(stringr)
library(lubridate)
```

## Load Clean Data

```{r}
saa_data_tidy <- read_tsv("../data/02_dat_clean.tsv")
```

## Augment Data

First we calculate means from the three data points of both the 24h & 150h measurements.

```{r}
means <- saa_data_tidy %>%
  group_by(patient_number, project, duration) %>%
  summarise(
    fmax_mean = mean(fmax, na.rm = TRUE),
    ttt_mean  = mean(ttt,  na.rm = TRUE),
    auc_mean  = mean(auc,  na.rm = TRUE),
    .groups = "drop"
  )

dat_aug <- saa_data_tidy %>%
  left_join(means,
            by = c("patient_number", "project", "duration"))
```

Prepare replicate vectors for SAA rule

```{r}
reps <- saa_data_tidy %>%
  group_by(patient_number, project, duration) %>%
  summarise(
    fmax_reps = list(fmax),
    .groups = "drop"
  )

dat_aug <- dat_aug %>%
  left_join(reps,
            by = c("patient_number", "project", "duration"))
```

We prepare to calculate the status from the fmax values by first creating two functions with the rules:

```{r}
saa_rule_155 <- function(x) {
  x <- unlist(x)
  n_pos <- sum(x >= 5000, na.rm = TRUE)

  case_when(
    n_pos == 3 ~ "Positive",
    n_pos <= 1 ~ "Negative",
    n_pos == 2 ~ "Inconclusive",
    TRUE ~ NA_character_
  )
}

saa_rule_237 <- function(x) {
  x <- unlist(x)

  n_ge_45000 <- sum(x >= 45000, na.rm = TRUE)
  n_ge_3000  <- sum(x >= 3000,  na.rm = TRUE)
  n_between  <- sum(x >= 3000 & x < 45000, na.rm = TRUE)
  n_lt_3000  <- sum(x < 3000, na.rm = TRUE)

  # Positive
  if (n_ge_45000 == 3) return("Positive")
  if (n_between == 2 | n_between == 3) return("Positive")
  if (n_ge_45000 == 2 & n_between == 1) return("Positive")

  # Negative
  if (n_ge_3000 <= 1) return("Negative")

  # Inconclusive
  if (n_ge_45000 == 2 & n_lt_3000 == 1) return("Inconclusive")
  if (n_ge_45000 == 1 & n_between == 1 & n_lt_3000 == 1) return("Inconclusive")

  NA_character_
}


```

\
Applying the functions:

```{r}
dat_aug <- dat_aug %>%
  rowwise() %>%
  mutate(
    saa_custom = case_when(
      project == "155" ~ saa_rule_155(fmax_reps),
      project == "237" ~ saa_rule_237(fmax_reps),
      TRUE ~ NA_character_
    )
  ) %>%
  ungroup()

```

lastly we calculate the days from baseline and remove the generated vector column before saving

```{r}
dat_aug <- dat_aug %>%
  mutate(rundate = as.Date(rundate)) %>%
  group_by(patient_number) %>%
  mutate(days_from_baseline = as.numeric(rundate - min(rundate, na.rm = TRUE))) %>%
  ungroup()

saa_data_aug <- dat_aug %>% select(-fmax_reps)
```

```{r}
saa_data_aug <- saa_data_aug |> 
  mutate(across(c(project, 
                  duration, 
                  rep, 
                  instrument), 
                
                as.character))
```

\
save the augmented data

```{r}
write_tsv(saa_data_aug, "../data/03_dat_aug.tsv")
```
